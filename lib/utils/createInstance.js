// Generated by CoffeeScript 1.4.0
(function() {
  var objectToTags, outcome, stepc, tagsToObject;

  stepc = require("stepc");

  outcome = require("outcome");

  objectToTags = require("./objectToTags");

  tagsToObject = require("./tagsToObject");

  module.exports = function(region, options, callback) {
    var newInstanceId, o;
    ectwo_log.log("%s: create server", region.name);
    o = outcome.e(callback);
    newInstanceId = null;
    return stepc.async(function() {
      return region.ec2.call("RunInstances", {
        "ImageId": options.imageId,
        "MinCount": options.count || 1,
        "MaxCount": options.count || 1,
        "InstanceType": options.flavor || "m1.small"
      }, this);
    }, o.s(function(result) {
      newInstanceId = result.instancesSet.item.instanceId;
      return region.instances.syncAndFindOne({
        _id: newInstanceId
      }, this);
    }), o.s(function(instance) {
      var tags,
        _this = this;
      tags = options.tags || {};
      tags.createdAt = Date.now();
      return instance.tags.create(objectToTags(tags), o.s(function() {
        console.log("STAGS");
        return _this(null, instance);
      }));
    }), callback);
  };

}).call(this);
