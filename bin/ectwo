#!/usr/bin/env node
var dref = require("dref"),
compileCommand = require("./compileCommand"),
ops = require('optimist').
usage('Usage: $0 [command] [options]').
alias("i", "interactive").
alias("c", "config").
alias("h", "help").
alias("p", "profile").
describe("interactive", "interactive terminal").
describe("config", "the ec2 config").
describe("profile", "the ec2 profile to use").
default("profile", "default").
default("config", "/usr/local/etc/ectwo/conf"),
argv = ops.argv;

if(argv.h) {
  ops.showHelp();
  process.exit()
}

var config = dref.get(require(argv.config), "profiles." + argv.profile);

if(!config) {
  console.error("profile %s doesn't exist", ops.profile);
  process.exit(1);
}


if(!argv.interactive && !argv._.length) {
  console.error("\nError: %s\n", "expecting -i (interactive mode), or command.");
  ops.showHelp();
  process.exit(1);
}

console.log("\nusing profile %s", argv.profile);


require("./cli")({
  config: config,
  interactive: argv.interactive,
  commands: argv._.map(compileCommand)
})