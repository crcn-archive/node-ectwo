#!/usr/bin/env node
var dref = require("dref"),
compileCommand = require("./compileCommand"),
ops = require('optimist').
usage('Usage: $0 [command] [options]').
alias("i", "interactive").
alias("c", "config").
alias("h", "help").
alias("p", "profile").
alias("v", "verbose").
alias("r", "regions").
describe("interactive", "interactive terminal").
describe("config", "the ec2 config").
describe("profile", "the ec2 profile to use").
describe("regions", "default regions to use").
describe("verbose", "verbose mode").
default("profile", "default").
default("config", "/usr/local/etc/ectwo/conf").
default("regions", require("../lib/utils/regions").join(", ")),
argv = ops.argv;

if(argv.h) {
  ops.showHelp();
  process.exit()
}

var config = dref.get(require(argv.config), "profiles." + argv.profile);

if(!config) {
  console.error("profile \"%s\" doesn't exist", argv.profile);
  process.exit(1);
}

if(!argv.interactive && !argv._.length) {
  console.error("Error: %s\n", "expecting -i (interactive mode), or command.");
  ops.showHelp();
  process.exit(1);
}
if(argv.v) {
  process.env.LOG_ECTWO = true;
}

var regions = config.regions || argv.r.split(/,\s*/g);

console.log("\n-----------------------------------------------\n");
console.log("interactive : %s", !!argv.i);
console.log("verbose     : %s", !!argv.v);
console.log("profile     : %s", argv.profile);
console.log("regions     : %s", regions.join(", "));
console.log("\n-----------------------------------------------\n");


require("./cli")({
  config: config,
  regions: regions,
  interactive: argv.interactive,
  commands: argv._.map(compileCommand)
})